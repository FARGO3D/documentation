
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Improving CUDA Performance &#8212; FARGO3D User Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cuda_perf';</script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="GPU vs CPU Benchmarking" href="benchmark.html" />
    <link rel="prev" title="VTK Compatibility" href="vtk_comp.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
    <meta name="docbuild:last-update" content="Dec 20, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">FARGO3D User Guide</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to the code</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributors.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Citing FARGO3D</a></li>

<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="first_steps.html">First Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="dir_tree.html">Directory tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="make_proc.html">Make Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundaries.html">Boundaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="mesh_fields.html">Mesh and Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="def_setups.html">Default SETUPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="opt_file.html">.opt files</a></li>
<li class="toctree-l1"><a class="reference internal" href="non_uniform_meshes.html">Non-uniform meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="nbody.html">N-Body solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="multifluid.html">Multifluid</a></li>
<li class="toctree-l1"><a class="reference internal" href="induction_equation.html">Induction equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="new_setup.html">Defining a new SETUP</a></li>

<li class="toctree-l1"><a class="reference internal" href="outputs.html">Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="communications.html">Communications</a></li>
<li class="toctree-l1"><a class="reference internal" href="c2cuda.html">Cuda translator (C2CUDA.py)</a></li>
<li class="toctree-l1"><a class="reference internal" href="exec_flags.html">Execution flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="vtk_comp.html">VTK Compatibility</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Improving CUDA Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">GPU vs CPU Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="complex_setup.html">Developing a complex setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="ttt.html">Tips, Tricks, Todos and Troubleshooting</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/cuda_perf.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Improving CUDA Performance</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mpicuda">MPICUDA</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="improving-cuda-performance">
<span id="performance"></span><h1>Improving CUDA Performance<a class="headerlink" href="#improving-cuda-performance" title="Link to this heading">#</a></h1>
<p>One can regard the action of a CUDA kernel on a mesh as the
distribution of elementary tasks (one mesh cell = one elementary task)
to the CUDA cores of the GPU. The CUDA cores are distributed within
<em>streaming multiprocessors</em> (SMP) on board the GPU. For instance, on a
Kepler K20 GPU, there are 13 SMP, with 192 cores each (for single
precision data), hence there are in total 2496 CUDA cores. In a
similar manner, splitting the whole task into threads that perform
elementary tasks on the CUDA core obeys a two-level hierarchy: the
global mesh must be split in <em>logical blocks</em>,  and the blocks are
then split in threads. The user has to determine the size of the
blocks in X, Y and Z. A given block runs on a single SMP. If you
choose blocks that are too small, the SMPs are underused and the
performance is degraded. If you choose blocks that are too large, the
small amount of memory within the SMPs (48k) is saturated and the
extra data is stored within the device’s global memory (the “Video
RAM”), with a dramatic performance penalty. There are other
considerations that matter the choice of the CUDA blocks (for instance
memory alignment), but in short it is obvious that there is an optimal
block size that will maximize performance. This size depends on:</p>
<blockquote>
<div><ul class="simple">
<li><p>the GPU</p></li>
<li><p>the kernel itself (it is not the same for all kernels of FARGO3D).</p></li>
</ul>
</div></blockquote>
<p>By default, the block sizes used in a kernel execution are the numbers
provided in the .opt file, which are “reasonable” numbers, but they
are the same for all kernels (hence they cannot be optimal).</p>
<p>A makefile rule combined with python scripting has been developed in
order to do perform a systematic test of the performance of each
kernel, individually, as a function of the size of the CUDA blocks.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">blocks</span></code> does not work when the <code class="docutils literal notranslate"><span class="pre">.opt</span></code> option <code class="docutils literal notranslate"><span class="pre">-DMPIIO</span></code> is enabled.</p>
</div>
<p>At compilation time, a file called setup.blocks (setup is the name of
your setup) is looked for in the corresponding <code class="docutils literal notranslate"><span class="pre">src/setup</span></code> directory
in order to provide to <code class="docutils literal notranslate"><span class="pre">c2cuda.py</span></code> the best block size for each
kernel. You could hand-write this file, but in practice, it is
automatically generated by the makefile when you execute the rule
called “blocks”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">blocks</span> <span class="n">setup</span><span class="o">=</span><span class="n">SETUP</span>
</pre></div>
</div>
<p>It is necessary to use “setup” in lower case in order to avoid a
misunderstanding with the SETUP variable. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">blocks</span> <span class="n">setup</span><span class="o">=</span><span class="n">fargo</span>
</pre></div>
</div>
<p>And you will see lines similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CompPresIso</span>     <span class="mi">64</span>      <span class="mi">8</span>       <span class="mi">1</span>        <span class="n">appended</span>
<span class="n">CompPresAd</span> <span class="n">was</span> <span class="n">skipped</span><span class="o">.</span>
<span class="n">compute_slopes</span> <span class="n">was</span> <span class="n">skipped</span><span class="o">.</span>
<span class="n">compute_star</span> <span class="n">was</span> <span class="n">skipped</span><span class="o">.</span>
<span class="n">compute_emf</span> <span class="n">was</span> <span class="n">skipped</span><span class="o">.</span>
<span class="n">update_magnetic</span> <span class="n">was</span> <span class="n">skipped</span><span class="o">.</span>
<span class="n">substep1_x</span>      <span class="mi">16</span>      <span class="mi">8</span>       <span class="mi">1</span>        <span class="n">appended</span>
<span class="n">substep1_y</span>      <span class="mi">32</span>      <span class="mi">4</span>       <span class="mi">1</span>        <span class="n">appended</span>
<span class="n">substep1_z</span> <span class="n">was</span> <span class="n">skipped</span><span class="o">.</span>
<span class="n">substep2_a</span>      <span class="mi">64</span>      <span class="mi">8</span>       <span class="mi">1</span>        <span class="n">appended</span>
<span class="o">...</span>
</pre></div>
</div>
<p>and a file called <code class="docutils literal notranslate"><span class="pre">fargo.blocks</span></code> inside <code class="docutils literal notranslate"><span class="pre">setups/fargo</span></code> is created
and is filled with this information, which represents the best block
size for each kernel. All the functions skipped were skipped because
they are not used in this particular setup.</p>
<p>It generally takes a few minutes. At the end, you have a .blocks file
similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CompPresIso</span>     <span class="mi">64</span>      <span class="mi">8</span>       <span class="mi">1</span>
<span class="n">substep1_x</span>      <span class="mi">16</span>      <span class="mi">8</span>       <span class="mi">1</span>
<span class="n">substep1_y</span>      <span class="mi">32</span>      <span class="mi">4</span>       <span class="mi">1</span>
<span class="n">substep2_a</span>      <span class="mi">64</span>      <span class="mi">8</span>       <span class="mi">1</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Now, each time you compile the code, this file is taken by the
c2cuda.py script. In the best cases, you can increase the
performance in a 10/20%. In 3D massive MHD problems, you will have a
maximum gain.</p>
<p>Note: The <code class="docutils literal notranslate"><span class="pre">.blocks</span></code> file could be saved for the future if you want to
save time. In theory, the .blocks file is hardware dependent. Be
careful if you share the same file on multiple platforms.</p>
<section id="mpicuda">
<h2>MPICUDA<a class="headerlink" href="#mpicuda" title="Link to this heading">#</a></h2>
<p>The considerations about GPU Direct and improvement of MPI
communications between GPUs have been exposed in section <a class="reference internal" href="communications.html#mpicuda"><span class="std std-ref">CUDA aware MPI implementations</span></a>.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="vtk_comp.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">VTK Compatibility</p>
      </div>
    </a>
    <a class="right-next"
       href="benchmark.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">GPU vs CPU Benchmarking</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mpicuda">MPICUDA</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Author name not set
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2014-2023, Pablo Benítez Llambay, Frédéric Masset &amp; Contributors.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on Dec 20, 2024.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>